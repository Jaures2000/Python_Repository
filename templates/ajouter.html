<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ajouter un patrimoine</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>

  <body>
    {% if session.get("id_user") %}
      <a class="logout-btn" href="/logout" title="Se déconnecter" aria-label="Se déconnecter">
        <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M18.4 5.6a8 8 0 1 1-12.8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </a>
    {% endif %}

    <header class="navbar">
      <div class="nav-inner">
        <a class="brand" href="/">
          <div class="brand-badge" aria-hidden="true">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>

          <div class="brand-title">
            <strong>Ajouter un patrimoine</strong>
            <span>Choisissez un point sur la carte</span>
          </div>
        </a>

        <div class="nav-actions">
          <a href="/" style="text-decoration:none">
            <button class="btn inline secondary">← Retour à la grande map</button>
          </a>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <h2>Formulaire</h2>
        <p>Cliquez sur la carte à droite : latitude et longitude seront remplies automatiquement.</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash {{ category }}">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="post" action="/ajouter">
          <div class="form-group">
            <label>Nom du patrimoine</label>
            <input type="text" name="nom" placeholder="Ex: Pharmacie Ajololo" required />
          </div>

          <div class="form-group">
            <label>Latitude</label>
            <input type="text" name="latitude" placeholder="Cliquez sur la carte" required />
          </div>

          <div class="form-group">
            <label>Longitude</label>
            <input type="text" name="longitude" placeholder="Cliquez sur la carte" required />
          </div>

          <button type="submit" class="btn">Enregistrer</button>
        </form>
      </section>

      <section class="card">
        <h3>Choisir l’emplacement</h3>
        <div id="map"></div>
      </section>
    </main>

    <script>
      const map = L.map("map").setView([6.13, 1.22], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap",
      }).addTo(map);

      let marker;

      map.on("click", function (e) {
        const lat = e.latlng.lat.toFixed(6);
        const lon = e.latlng.lng.toFixed(6);

        document.querySelector('input[name="latitude"]').value = lat;
        document.querySelector('input[name="longitude"]').value = lon;

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map);
      });
    </script>
  </body>
</html>
